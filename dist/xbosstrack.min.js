!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.xbosstrack=t()}(this,function(){var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},r=App,o=Page,a=function(){function n(t){var a=this;e(this,n),this.injectPageMethods=[],this.injectAppMethods=[],this.extraPageMethods=[],this.extraAppMethods=[],t||(App=function(e){return r(a._create(e,a.injectAppMethods,a.extraAppMethods))},Page=function(e){return o(a._create(e,a.injectPageMethods,a.extraPageMethods))})}return t(n,[{key:"_wrapTargetMethod",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=e[t];e[t]=function(){for(var o=this,a=arguments.length,i=Array(a),c=0;c<a;c++)i[c]=arguments[c];var u=r&&r.apply(this,i),f=function(){n.forEach(function(n){n.apply(o,[e,t].concat(i))})};try{"[object Promise]"===Object.prototype.toString.call(u)?u.then(function(){f()}).catch(function(){f()}):f()}catch(e){console.error(t,"钩子函数执行出现错误",e)}return u}}},{key:"_addExtraMethod",value:function(e,t){t.forEach(function(t){var n=t.name;e[n]=t})}},{key:"_create",value:function(e,t,n){var r=this;return Object.keys(e).filter(function(t){return"function"==typeof e[t]}).forEach(function(n){r._wrapTargetMethod(e,n,t)}),this._addExtraMethod(e,n),e}},{key:"addPageMethodWrapper",value:function(e){this.injectPageMethods.push(e)}},{key:"addAppMethodWrapper",value:function(e){this.injectAppMethods.push(e)}},{key:"addPageMethodExtra",value:function(e){this.extraPageMethods.push(e)}},{key:"addAppMethodExtra",value:function(e){this.extraAppMethods.push(e)}},{key:"createApp",value:function(e){r(this._create(e,this.injectAppMethods,this.extraAppMethods))}},{key:"createPage",value:function(e){o(this._create(e,this.injectPageMethods,this.extraPageMethods))}}]),n}(),i=function(){var e=getCurrentPages();return e.length?e[e.length-1]:{}},c=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2],r=t.index,o=e.split("."),a=n;return o.length>-1?o.forEach(function(e){var t=function(e,t){var n=e.indexOf("["),r=e.indexOf("]"),o={};if(n>-1){var a=e.substring(n+1,r),i=e.substring(0,n);"$INDEX"===a&&(a=t),o.key=i,o.index=parseInt(a,10)}return o}(e,r);a=t.key?a[t.key][t.index]:a[e]}):a=n[e],a},u=function(e,t,n){try{return 0===e.indexOf("$")?function(e,t){var n="";e.indexOf("$APP.")>-1?n=getApp()[e.split("$APP.")[1]]:e.indexOf("$DATASET.")>-1?n=t[e.split("$DATASET.")[1]]:e.indexOf("$INDEX")>-1&&(n=t.index);return n}(e,t):c(e,t,n)}catch(e){return console.log(e),""}},f=function(e,t){var n=e.element,r=e.method,o=[];e.dataKeys.forEach(function(a){var i=u(a,e.dataset,t);o.push({element:n,method:r,name:a,data:i})}),console.table(o)};return function(r){function o(t){var r=t.tracks,a=t.isUsingPlugin;e(this,o);var i=n(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,a));return i.tracks=r,i.addPageMethodExtra(i.elementTracker()),i.addPageMethodWrapper(i.methodTracker()),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(o,a),t(o,[{key:"elementTracker",value:function(){var e=this,t=function(t){var n=e.findActivePageTracks("element"),r=i().data;n.forEach(function(e){var n;(n=e.element,new Promise(function(e){var t=wx.createSelectorQuery();t.selectAll(n).boundingClientRect(),t.selectViewport().scrollOffset(),t.exec(function(t){return e({boundingClientRect:t[0],scrollOffset:t[1]})})})).then(function(n){n.boundingClientRect.forEach(function(o){var a=function(e,t,n){if(!t)return!1;var r=e.detail,o=r.x,a=r.y,i=t.left,c=t.right,u=t.top,f=t.height,s=n.scrollTop;return i<o&&o<c&&s+u<a&&a<s+u+f}(t,o,n.scrollOffset);e.dataset=o.dataset,a&&f(e,r)})})})};return t}},{key:"methodTracker",value:function(){var e=this;return function(t,n){var r=e.findActivePageTracks("method"),o=i().data;r.forEach(function(e){e.method===n&&f(e,o)})}}},{key:"findActivePageTracks",value:function(e){try{var t=i().route,n=this.tracks.find(function(e){return e.path===t})||{},r={};return"method"===e?r=n.methodTracks||[]:"element"===e&&(r=n.elementTracks||[]),r}catch(e){return{}}}}]),o}()});
